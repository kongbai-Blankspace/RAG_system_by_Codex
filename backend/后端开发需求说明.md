# 后端开发需求说明

本说明面向需要从零实现 RAG_system_by_Codex 后端的开发人员，覆盖当前上线能力、环境要求、接口契约及验收标准。严格按照本文实现，可在无需参考现有代码的情况下完成后端重构并达到现有功能水平。

## 1. 背景与目标
- 提供一个文档驱动的问答（RAG）后端，支持文档上传校验、向量索引构建、基于 LangChain/LangGraph 的对话式检索问答，以及基础运维能力（健康检查、根路由）。
- 面向前端应用暴露 RESTful API，接口风格与 `/api/v1` 前缀保持一致，返回 JSON 并利用 Pydantic 校验。
- 依赖本地 SQLite 作为持久化存储，可在后续替换为其他 SQL 数据库。

## 2. 系统总体设计
### 2.1 技术栈
- **语言**：Python ≥ 3.10。
- **Web 框架**：FastAPI（Pydantic v2 输入输出校验）。
- **工作流/RAG**：LangChain、LangGraph，用于模型调用与检索流程编排。
- **向量索引**：FAISS（本地保存）；支持 OpenAI/DeepSeek Embedding，缺省回退到自定义 deterministic embeddings。
- **数据库**：SQLModel + SQLite；统一会话管理器 `get_session()`。
- **部署**：Uvicorn 运行，支持环境变量配置。

### 2.2 核心流程概览
1. 用户上传文档 → 后端校验并保存任务记录。
2. 前端基于成功的任务请求构建向量库 → 后端切分文本、生成向量并持久化。
3. 用户发起对话消息 → 后端保存对话、可选读取向量库上下文、调用 LLM 生成回答并返回引用信息。

### 2.3 模块划分
- `documents`：处理上传、校验、任务状态查询。
- `vector_stores`：向量库创建、状态查询、知识召回。
- `chat`：会话生命周期管理、消息存取、RAG 推理。
- `health`：基础健康检查。

## 3. 环境与配置要求
- 统一通过 `app.config.Settings` 读取配置，支持 `.env` 与环境变量。关键字段：
  - `DATA_DIR`、`DOCUMENT_DIR`、`VECTOR_DIR`
  - `ALLOWED_EXTENSIONS`（默认 `.txt,.md,.pdf`）
  - `MAX_FILE_SIZE_MB`（默认 50）
  - `MIN_DOCUMENT_LENGTH`（默认 200 字符）
  - `OPENAI_API_KEY`、`DEEPSEEK_API_KEY`、`EMBED_API_KEY`
  - `OPENAI_BASE_URL`、`EMBED_BASE_URL`
  - `MODEL_NAME`（默认 `deepseek-chat`）与 `EMBED_MODEL`
- 初始化时需创建数据目录、文档目录、向量目录，初始化 SQLite 数据库并建表。
- CORS 对所有来源开放（开发阶段），可按需收紧。

## 4. 功能模块需求
### 4.1 基础服务
- `GET /`：返回 `{"message": "RAG backend running", "port": <port>}`，用于快速探测。
- `GET /healthz`：返回 `{status:"ok", service:<app_name>}`；读取配置确保服务在运行。

### 4.2 文档上传与校验模块
**业务流程**
1. 接收单文件上传（字段名 `file`）。
2. 读取文件元信息（名称、扩展名、MIME、大小）。
3. 校验：扩展名允许列表；文件大小不超过限制；尝试解析文本内容（TXT/MD 直接读取；PDF 先尝试 PyPDF2，再退回 pdfminer）；文本长度 ≥ `min_document_length`。
4. 累计校验规则结果，任何失败均视为整体失败。
5. 校验通过：写入磁盘（`${DOCUMENT_DIR}/{taskId}.{ext}`）；写入 `document_tasks` 记录（状态 `success`）。
6. 校验失败：返回 400 + `DATASET_INVALID` 错误；仍需记录任务（状态 `failed`，message 填写“文档校验未通过”），不保存文件。

**接口要求**
- `POST /api/v1/documents`
  - 请求：multipart/form-data，字段 `file`。
  - 成功响应：201，`DocumentTaskStatusResponse`（包含 taskId、validation 详情）。
  - 失败响应：400，`{"detail": {code: "DATASET_INVALID", message, issues}}`。
- `GET /api/v1/documents/{taskId}`
  - 成功：200，返回已有校验记录。
  - 未找到：404，`{"detail": "Document task not found"}`。

**存储要求**
- `document_tasks` 表需要字段：task_id、file_name、file_type、file_size、status、validation(JSON)、message、file_path、created_at、updated_at。

**验收标准**
- 同一文件重复上传仍返回新 taskId。
- 不允许扩展名、超限大小、文本太短均给出对应 validation rule。
- PDF 解析失败时记录 `content_parse` 规则并附上异常原因。

### 4.3 向量存储模块
**流程**
1. 接收前端请求（携带 `documentTaskId` + `config`）。
2. 校验任务存在且状态为 `success`，否则返回 404/400。
3. 读取任务文本，使用 `RecursiveCharacterTextSplitter` 按 `chunkSize`、`overlap` 切分。
4. 构建 Embeddings：优先使用 OpenAI/DeepSeek；若缺少 API key 或调用报错，切换到 `FallbackEmbeddings`。
5. 基于 FAISS 创建向量存储并以 `{VECTOR_DIR}/{storeId}` 持久化。
6. 写入 `vector_store_records`（store_id、name、document_task_id、config、status、failure_reason、timestamps，默认 status=`ready`）。

**接口**
- `POST /api/v1/vector-stores`
  - 请求：`CreateVectorStoreRequest`（config 包含 name、chunkSize、overlap、topK）。
  - 响应：202，返回 `CreateVectorStoreResponse`（storeId、taskId、statusUrl）。
- `GET /api/v1/vector-stores/{storeId}` → 返回 `VectorStore`。
- `GET /api/v1/vector-stores/{storeId}/tasks/{taskId}` → 查询构建状态，progress 对于 ready=1.0，否则 0.5，message 传 failureReason。
- `POST /api/v1/vector-stores/{storeId}/recall`
  - 请求：`RecallRequest`（query、topK、withContent）。
  - 逻辑：根据存储的 embeddingBackend 决定使用原 embedding 还是 fallback；若原召回失败且不是 fallback，再次使用 fallback。
  - 响应：`RecallResponse`，返回文档片段列表（含 id、title、similarity、content、metadata）。

**验收标准**
- 向量库创建失败需记录 `failure_reason` 并返回 500/400 合理错误。
- 同一文档可创建多个向量库（store_id 唯一）。
- 召回时 `withContent=False` 提供截断内容（前 100 字符）。

### 4.4 会话与聊天模块
**会话管理**
- `POST /api/v1/chat/sessions`
  - 请求：`CreateChatSessionRequest`（可选 title）。
  - 响应：201，返回 `ChatSession`（自动生成 session_id、时间戳）。若未提供标题，默认使用“新的对话”。
- `GET /api/v1/chat/sessions`
  - 支持分页参数 `page`（默认1）与 `page_size`（默认20，最大100）。
  - 返回 `ChatSessionListResponse`，按 `updated_at` 倒序。
- `GET /api/v1/chat/sessions/{sessionId}` → 返回会话详情及所有消息，按时间排序。
- `DELETE /api/v1/chat/sessions/{sessionId}` → 删除会话及其消息，返回 204。

**消息与 RAG 推理**
- `POST /api/v1/chat/sessions/{sessionId}/messages`
  - 请求：`SendChatMessageRequest`（`message` 为必填文本，`vectorStoreId` 可选）。
  - 流程：
    1. 将用户消息写入 `chat_messages`（role=`user`）。
    2. 构造 `RecallRequest`（withContent=True，topK=3，query=用户消息）。
    3. 若提供 `vectorStoreId`，调用 `vector_stores.recall` 获取上下文；否则上下文为空。
    4. 通过 LangGraph 流程：
       - `ingest` 节点加载引用上下文。
       - `respond` 节点拼接系统提示、用户提示，调用 `chat_model.invoke()` 生成回复；若模型返回“我不知道”类回答，替换为更友好的提示。
       - 将回复写回图状态，再返回。
    5. 将助手回复与引用列表写入 `chat_messages`（role=`assistant`）。
  - 响应：`ChatMessageResponse`（返回新建助手消息）。
- RAG 系统提示需限制回答范围，无法回答时明确说明。
- 需要记录 `citations` 并在消息中保存。

**验收标准**
- 任意失败应记录日志并返回 FastAPI HTTPException。
- 没有可用回答时返回友好文案（而非空字符串）。
- 会话更新需刷新 `updated_at`。

### 4.5 数据模型与迁移
| 表名 | 关键字段 | 说明 |
|------|----------|------|
| `document_tasks` | task_id, status, validation(JSON), file_path | 文档上传与校验记录 |
| `vector_store_records` | store_id, document_task_id, config(JSON), status | 向量库元数据 |
| `vector_store_tasks` | task_id, store_id, status, progress | 预留的任务队列记录（当前用于状态接口返回固定值） |
| `chat_sessions` | session_id, title, created_at, updated_at | 会话信息 |
| `chat_messages` | message_id, session_id, role, content, citations(JSON) | 会话消息 |

- 所有模型需继承 `SQLModel` 并使用 UTC 时间戳（`datetime.utcnow`）。
- 迁移策略：首次启动运行 `SQLModel.metadata.create_all()`；如需切换数据库，需提供 migration 方案（例如 Alembic）。

## 5. 外部依赖与约束
- LangChain/LangGraph 版本需与源码兼容（当前基于 0.2+ API）。
- Embedding 服务：优先使用 `langchain_openai.OpenAIEmbeddings`，需配置 API Key 和 Base URL；无可用 Key 时必须回退到 `FallbackEmbeddings` 以保证测试可运行。
- 文档解析：可选依赖 PyPDF2、pdfminer.six；若未安装，对 PDF 自动判定校验失败并给出提示。
- 所有模型调用需设置 `temperature=0`，保证确定性测试。

## 6. 非功能需求
- **日志**：使用 Python logging，INFO 级打印关键流程（模型初始化、生成回答等），错误通过 `logger.error/exception` 记录；调试信息（例如 RAG 统计）使用 DEBUG 级。
- **错误处理**：所有业务异常统一抛出 `HTTPException`，前端根据 `detail` 获取错误码与提示。
- **测试**：保留 `backend/tests/test_api.py` 的端到端校验，覆盖文档上传失败、向量召回、聊天会话三个主要流程。新增功能需补充测试。
- **国际化**：默认中文文案，可通过配置扩展为多语言。
- **安全**：当前 CORS 与 API 访问未限制，仅用于内部测试。正式环境需接入鉴权与速率限制。

## 7. 开发任务分解与里程碑
1. **环境初始化**：完成 Settings、数据库初始化、目录创建、CORS 配置。
2. **文档模块**：实现上传接口、校验逻辑、任务查询；通过对应 pytest。
3. **向量模块**：实现向量库创建、状态、召回；支持 embedding fallback 与 FAISS 持久化。
4. **会话模块**：实现 CRUD、消息写入、LangGraph 工作流、回答回退文案。
5. **系统收尾**：健康检查、根路由、日志优化、错误处理、测试通过。
6. **部署验证**：提供 `uvicorn app.main:app --host 0.0.0.0 --port 8002` 启动脚本；准备 `.env` 示例。

每一阶段完成后需在测试环境验证 API，确保返回结构与本文档一致。

## 8. 扩展与待办
- 向量库构建可接入后台任务队列（如 Celery、RQ），替换当前同步实现。
- 引入消息/会话分页、搜索等增强功能。
- 完善错误码体系与日志 traceId。
- 计划接入多模型策略与答案引用展示优化。

---

此文档为后端开发需求的权威来源，后续变更需同步更新，以保障跨团队协作一致性。
